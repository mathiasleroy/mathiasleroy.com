Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var a,b;for(a=0,b=0;a<this.length;a++)b+=this[a];return b/this.length},Array.prototype.rep=function(a){return Array.apply(null,new Array(a)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(a,b){var c,d,e=!1;for(c=0,d=this.length-1;c<this.length;d=c++)this[c][1]>b!=this[d][1]>b&&a<(this[d][0]-this[c][0])*(b-this[c][1])/(this[d][1]-this[c][1])+this[c][0]&&(e=!e);return e};var kriging=function(){var a={};return kriging_matrix_diag=function(a,b){var c,d=[0].rep(b*b);for(c=0;c<b;c++)d[c*b+c]=a;return d},kriging_matrix_transpose=function(a,b,c){var d,e,f=Array(c*b);for(d=0;d<b;d++)for(e=0;e<c;e++)f[e*b+d]=a[d*c+e];return f},kriging_matrix_scale=function(a,b,c,d){var e,f;for(e=0;e<c;e++)for(f=0;f<d;f++)a[e*d+f]*=b},kriging_matrix_add=function(a,b,c,d){var e,f,g=Array(c*d);for(e=0;e<c;e++)for(f=0;f<d;f++)g[e*d+f]=a[e*d+f]+b[e*d+f];return g},kriging_matrix_multiply=function(a,b,c,d,e){var f,g,h,i=Array(c*e);for(f=0;f<c;f++)for(g=0;g<e;g++)for(i[f*e+g]=0,h=0;h<d;h++)i[f*e+g]+=a[f*d+h]*b[h*e+g];return i},kriging_matrix_chol=function(a,b){var c,d,e,g=Array(b);for(c=0;c<b;c++)g[c]=a[c*b+c];for(c=0;c<b;c++){for(d=0;d<c;d++)g[c]-=a[c*b+d]*a[c*b+d];if(g[c]<=0)return!1;for(g[c]=Math.sqrt(g[c]),d=c+1;d<b;d++){for(e=0;e<c;e++)a[d*b+c]-=a[d*b+e]*a[c*b+e];a[d*b+c]/=g[c]}}for(c=0;c<b;c++)a[c*b+c]=g[c];return!0},kriging_matrix_chol2inv=function(a,b){var c,d,e,f;for(c=0;c<b;c++)for(a[c*b+c]=1/a[c*b+c],d=c+1;d<b;d++){for(f=0,e=c;e<d;e++)f-=a[d*b+e]*a[e*b+c];a[d*b+c]=f/a[d*b+d]}for(c=0;c<b;c++)for(d=c+1;d<b;d++)a[c*b+d]=0;for(c=0;c<b;c++){for(a[c*b+c]*=a[c*b+c],e=c+1;e<b;e++)a[c*b+c]+=a[e*b+c]*a[e*b+c];for(d=c+1;d<b;d++)for(e=d;e<b;e++)a[c*b+d]+=a[e*b+c]*a[e*b+d]}for(c=0;c<b;c++)for(d=0;d<c;d++)a[c*b+d]=a[d*b+c]},kriging_matrix_solve=function(a,b){var h,i,j,k,l,m,n,o,p,q,r,c=b,d=Array(b*b),e=Array(b),f=Array(b),g=Array(b);for(h=0;h<b;h++)for(k=0;k<b;k++)h==k?d[h*b+k]=1:d[h*b+k]=0;for(k=0;k<b;k++)g[k]=0;for(h=0;h<b;h++){for(o=0,k=0;k<b;k++)if(1!=g[k])for(l=0;l<b;l++)0==g[l]&&Math.abs(a[k*b+l])>=o&&(o=Math.abs(a[k*b+l]),j=k,i=l);if(++g[i],j!=i){for(m=0;m<b;m++)r=a[j*b+m],a[j*b+m]=a[i*b+m],a[i*b+m]=r;for(m=0;m<c;m++)r=d[j*b+m],d[j*b+m]=d[i*b+m],d[i*b+m]=r}if(f[h]=j,e[h]=i,0==a[i*b+i])return!1;for(q=1/a[i*b+i],a[i*b+i]=1,m=0;m<b;m++)a[i*b+m]*=q;for(m=0;m<c;m++)d[i*b+m]*=q;for(n=0;n<b;n++)if(n!=i){for(p=a[n*b+i],a[n*b+i]=0,m=0;m<b;m++)a[n*b+m]-=a[i*b+m]*p;for(m=0;m<c;m++)d[n*b+m]-=d[i*b+m]*p}}for(m=b-1;m>=0;m--)if(f[m]!=e[m])for(l=0;l<b;l++)r=a[l*b+f[m]],a[l*b+f[m]]=a[l*b+e[m]],a[l*b+e[m]]=r;return!0},kriging_variogram_gaussian=function(a,b,c,d,e){return b+(d-b)/c*(1-Math.exp(-(1/e)*Math.pow(a/c,2)))},kriging_variogram_exponential=function(a,b,c,d,e){return b+(d-b)/c*(1-Math.exp(-(1/e)*(a/c)))},kriging_variogram_spherical=function(a,b,c,d,e){return a>c?b+(d-b)/c:b+(d-b)/c*(1.5*(a/c)-.5*Math.pow(a/c,3))},a.train=function(a,b,c,d,e,f){var g={t:a,x:b,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(d){case"gaussian":g.model=kriging_variogram_gaussian;break;case"exponential":g.model=kriging_variogram_exponential;break;case"spherical":g.model=kriging_variogram_spherical}var h,i,j,k,l=a.length,m=Array((l*l-l)/2);for(h=0,j=0;h<l;h++)for(i=0;i<h;i++,j++)m[j]=Array(2),m[j][0]=Math.pow(Math.pow(b[h]-b[i],2)+Math.pow(c[h]-c[i],2),.5),m[j][1]=Math.abs(a[h]-a[i]);m.sort(function(a,b){return a[0]-b[0]}),g.range=m[(l*l-l)/2-1][0];var n=(l*l-l)/2>30?30:(l*l-l)/2,o=g.range/n,p=[0].rep(n),q=[0].rep(n);if(n<30)for(k=0;k<n;k++)p[k]=m[k][0],q[k]=m[k][1];else{for(h=0,i=0,j=0,k=0;h<n&&i<(l*l-l)/2;h++,j=0){for(;m[i][0]<=(h+1)*o&&(p[k]+=m[i][0],q[k]+=m[i][1],i++,j++,!(i>=(l*l-l)/2)););j>0&&(p[k]/=j,q[k]/=j,k++)}if(k<2)return g}l=k,g.range=p[l-1]-p[0];var r=[1].rep(2*l),s=Array(l),t=g.A;for(h=0;h<l;h++){switch(d){case"gaussian":r[2*h+1]=1-Math.exp(-(1/t)*Math.pow(p[h]/g.range,2));break;case"exponential":r[2*h+1]=1-Math.exp(-(1/t)*p[h]/g.range);break;case"spherical":r[2*h+1]=1.5*(p[h]/g.range)-.5*Math.pow(p[h]/g.range,3)}s[h]=q[h]}var u=kriging_matrix_transpose(r,l,2),v=kriging_matrix_multiply(u,r,2,l,2);v=kriging_matrix_add(v,kriging_matrix_diag(1/f,2),2,2);var w=v.slice(0);kriging_matrix_chol(v,2)?kriging_matrix_chol2inv(v,2):(kriging_matrix_solve(w,2),v=w);var x=kriging_matrix_multiply(kriging_matrix_multiply(v,u,2,2,l),s,2,l,1);g.nugget=x[0],g.sill=x[1]*g.range+g.nugget,g.n=b.length,l=b.length;var y=Array(l*l);for(h=0;h<l;h++){for(i=0;i<h;i++)y[h*l+i]=g.model(Math.pow(Math.pow(b[h]-b[i],2)+Math.pow(c[h]-c[i],2),.5),g.nugget,g.range,g.sill,g.A),y[i*l+h]=y[h*l+i];y[h*l+h]=g.model(0,g.nugget,g.range,g.sill,g.A)}var z=kriging_matrix_add(y,kriging_matrix_diag(e,l),l,l),A=z.slice(0);kriging_matrix_chol(z,l)?kriging_matrix_chol2inv(z,l):(kriging_matrix_solve(A,l),z=A);var y=z.slice(0),B=kriging_matrix_multiply(z,a,l,l,1);return g.K=y,g.M=B,g},a.predict=function(a,b,c){var d,e=Array(c.n);for(d=0;d<c.n;d++)e[d]=c.model(Math.pow(Math.pow(a-c.x[d],2)+Math.pow(b-c.y[d],2),.5),c.nugget,c.range,c.sill,c.A);return kriging_matrix_multiply(e,c.M,1,c.n,1)[0]},a.variance=function(a,b,c){var d,e=Array(c.n);for(d=0;d<c.n;d++)e[d]=c.model(Math.pow(Math.pow(a-c.x[d],2)+Math.pow(b-c.y[d],2),.5),c.nugget,c.range,c.sill,c.A);return c.model(0,c.nugget,c.range,c.sill,c.A)+kriging_matrix_multiply(kriging_matrix_multiply(e,c.K,1,c.n,c.n),e,1,c.n,1)[0]},a.grid=function(b,c,d){var e,f,g,h=b.length;if(0!=h){var i=[b[0][0][0],b[0][0][0]],j=[b[0][0][1],b[0][0][1]];for(e=0;e<h;e++)for(f=0;f<b[e].length;f++)b[e][f][0]<i[0]&&(i[0]=b[e][f][0]),b[e][f][0]>i[1]&&(i[1]=b[e][f][0]),b[e][f][1]<j[0]&&(j[0]=b[e][f][1]),b[e][f][1]>j[1]&&(j[1]=b[e][f][1]);var k,l,m=Array(2),n=Array(2),o=Array(2),p=Array(2),q=Math.ceil((i[1]-i[0])/d),r=Math.ceil((j[1]-j[0])/d),s=Array(q+1);for(e=0;e<=q;e++)s[e]=Array(r+1);for(e=0;e<h;e++){for(o[0]=b[e][0][0],o[1]=o[0],p[0]=b[e][0][1],p[1]=p[0],f=1;f<b[e].length;f++)b[e][f][0]<o[0]&&(o[0]=b[e][f][0]),b[e][f][0]>o[1]&&(o[1]=b[e][f][0]),b[e][f][1]<p[0]&&(p[0]=b[e][f][1]),b[e][f][1]>p[1]&&(p[1]=b[e][f][1]);for(m[0]=Math.floor((o[0]-(o[0]-i[0])%d-i[0])/d),m[1]=Math.ceil((o[1]-(o[1]-i[1])%d-i[0])/d),n[0]=Math.floor((p[0]-(p[0]-j[0])%d-j[0])/d),n[1]=Math.ceil((p[1]-(p[1]-j[1])%d-j[0])/d),f=m[0];f<=m[1];f++)for(g=n[0];g<=n[1];g++)k=i[0]+f*d,l=j[0]+g*d,b[e].pip(k,l)&&(s[f][g]=a.predict(k,l,c))}return s.xlim=i,s.ylim=j,s.zlim=[c.t.min(),c.t.max()],s.width=d,s}},a.contour=function(a,b,c){},a.plot=function(a,b,c,d,e){var f=a.getContext("2d");f.clearRect(0,0,a.width,a.height);var h,i,j,k,l,g=[c[1]-c[0],d[1]-d[0],b.zlim[1]-b.zlim[0]],m=b.length,n=b[0].length,o=Math.ceil(b.width*a.width/(c[1]-c[0])),p=Math.ceil(b.width*a.height/(d[1]-d[0]));for(h=0;h<m;h++)for(i=0;i<n;i++)void 0!=b[h][i]&&(j=a.width*(h*b.width+b.xlim[0]-c[0])/g[0],k=a.height*(1-(i*b.width+b.ylim[0]-d[0])/g[1]),l=(b[h][i]-b.zlim[0])/g[2],l<0&&(l=0),l>1&&(l=1),f.fillStyle=e[Math.floor((e.length-1)*l)],f.fillRect(Math.round(j-o/2),Math.round(k-p/2),o,p))},a}();